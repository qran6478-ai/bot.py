import os
import asyncio
import tempfile
from pathlib import Path
from telegram import Update, InputFile
from telegram.ext import (
    Application,
    CommandHandler,
    MessageHandler,
    ContextTypes,
    filters,
)

TOKEN = os.getenv("TOKEN")

async def start_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "ğŸ‘‹ Ù…Ø±Ø­Ø¨Ø§! Ø£Ù†Ø§ Ø¨ÙˆØª Ø§Ù„ØªØ­Ù…ÙŠÙ„.\n"
        "ğŸ”» Ø£Ø±Ø³Ù„ Ø§Ù„Ø£Ù…Ø±:\n"
        "/ØªØ­Ù…ÙŠÙ„ Ø±Ø§Ø¨Ø·\n"
        "Ø¨Ø§Ø´ Ù†Ø­Ù…Ù„Ù‘Ùƒ ÙÙŠØ¯ÙŠÙˆ Ø£Ùˆ ØµÙˆØª."
    )

async def download_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not context.args:
        await update.message.reply_text("â— Ø§ÙƒØªØ¨ Ù‡ÙƒØ°Ø§:\n/ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø§Ø¨Ø·")
        return

    url = context.args[0]
    msg = await update.message.reply_text("â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„... Ø§Ø³ØªÙ†Ù‰ Ø´ÙˆÙŠØ©.")

    def ØªØ­Ù…ÙŠÙ„_ÙÙŠØ¯ÙŠÙˆ(link, folder):
        import yt_dlp
        Ø®ÙŠØ§Ø±Ø§Øª = {
            "outtmpl": os.path.join(folder, "%(title)s.%(ext)s"),
            "format": "best",
            "noplaylist": True,
            "quiet": True,
        }
        with yt_dlp.YoutubeDL(Ø®ÙŠØ§Ø±Ø§Øª) as yt:
            info = yt.extract_info(link, download=True)
            return yt.prepare_filename(info)

    try:
        with tempfile.TemporaryDirectory() as tmp:
            loop = asyncio.get_running_loop()
            Ø§Ù„Ù…Ù„Ù = await loop.run_in_executor(None, ØªØ­Ù…ÙŠÙ„_ÙÙŠØ¯ÙŠÙˆ, url, tmp)

            path = Path(Ø§Ù„Ù…Ù„Ù)
            if path.stat().st_size > 48 * 1024 * 1024:
                await msg.edit_text("âš ï¸ Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± Ø¨Ø²Ø§ÙØŒ Ù…Ø§ Ù†Ù‚Ø¯Ø±Ø´ Ù†Ø±Ø³Ù„Ùˆ ÙƒØ§Ù…Ù„.")
                return

            await msg.edit_text("ğŸ“¤ Ù†Ø±Ø³Ù„ Ù„Ùƒ Ø§Ù„Ù…Ù„Ùâ€¦")
            await update.message.reply_document(
                document=InputFile(path.open("rb"), filename=path.name),
                caption="âœ”ï¸ ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„!"
            )
    except Exception as e:
        await msg.edit_text(f"âŒ ÙˆÙ‚Ø¹ Ø®Ø·Ø£: {e}")

async def main():
    app = Application.builder().token(TOKEN).build()
    app.add_handler(CommandHandler("start", start_cmd))
    app.add_handler(CommandHandler("ØªØ­Ù…ÙŠÙ„", download_cmd))
    print("Ø§Ù„Ø¨ÙˆØª Ø´ØºÙ‘Ø§Ù„â€¦")
    await app.run_polling()

if __name__ == "__main__":
    asyncio.run(main())
